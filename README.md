# Monorepo Microservice

Monorepo Microservices using nestjs kafka and docker, k8s

## Getting Started

To get a local copy up and running, please follow these simple steps.

### Prerequisites

Here is what you need.

### Prerequisite

- [Node.js](https://nodejs.org/en)  (Version: >= 20.x)
- [docker](https://docs.docker.com/engine/install/), [docker-compose (if not using k8s)](https://docs.docker.com/compose/install/) (Version: >= 26.x, 2.x)

#### If using k8s

- [minikube](https://minikube.sigs.k8s.io/docs/start/) (Version >= v1.33.1)
- [minikube ingress addon](https://minikube.sigs.k8s.io/docs/handbook/addons/ingress-dns/)
- [skaffold](https://skaffold.dev/docs/install/#standalone-binary) (Version >= v2.10.0)
- [helm](https://helm.sh/) (Version >= v3.14.3)

## Setup (development)

- Setup Node If your Node version does not meet the project's requirements as instructed by the docs, either [manually](https://nodejs.org/dist/latest-v20.x/) or using a tool like [nvm](https://github.com/nvm-sh/nvm) or [volta](https://volta.sh/) (recommended)

- Clone the repo

    ```bash
    git clone git@github.com:yadav-saurabh/monorepo-microservice.git
    ```

- Go to the project folder

    ```bash
    cd monorepo-microservice
    ```

### Using docker and docker-compose

- Install packages with npm

    ```bash
    npm i
    ```

- Set up your `.env` file

  - Duplicate `.env.example` to `.env`
  - Configure environment variables in the `.env` file. Replace the placeholder values with their applicable values

- Run docker compose to get all the services up and running

    ```bash
    docker-compose --env-file .env -f ./infra/compose.yaml up
    ```

- Run npm command `dev` it will start dev script for all the services and packages

    ```bash
    npm run dev
    ```

### Using kubernetes (minikube)

- Start minikube

    ```bash
    minikube start
    ```
  
- Get minikube ip and add it to hosts `minikube ip` to get the IP then edit the `/etc/hosts` files and add `<minikube ip>  <ingress host>`

    ```bash
    minikube ip
    ```

    ```txt
    192.168.49.2  microservices.test
    ```

- Run skaffold command `dev` it will run the skaffold in dev mode

    ```bash
    skaffold dev -f ./infra/skaffold.yaml --tail=true
    ```

## Test project

- Setup the project
- create a jwt token [jwt.io](https://jwt.io/), with `sub` and `isAdmin` object in the payload, or use dummy jwt in `test-jwt.json`
- call the apis with bearer token in the header

### Apis

#### /api/keys (key-management)

- POST (isAdmin should be true)
- GET
- PATCH
- DELETE

#### /api/tokens (web3-token)

- GET

**Here is the working example of project using Docker and Docker-Compose**: [Video Link](https://drive.google.com/file/d/1CjMzWYZ_-zSM_2eiGbGx4_EBfhrJhLZL/view?usp=sharing)  

## Project structure

- **Infra**: All infrastructure as code (IaC)

- **Services**: All the microservices directory

  - *key-management (microservice 1)*: generate keys with some meta data like rateLimit, expiration ...
  - *web3-token (microservice 2)*: get token information using the rateLimit and key info generated by `key-management`

- **Packages**: Common code used by `Services`

  - *auth*: Auth middleware get the tokens, decodes it and append it in req object.
  - *config*: General config used by `Services`
  - *error*: Common Error Exception class
  - *events*: Events Object used in `Services`

## TODO

- [ ] unit test
- [ ] Integration test
